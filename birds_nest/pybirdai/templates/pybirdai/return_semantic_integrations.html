<!--
# Copyright (c) 2024 Bird Software Solutions Ltd
# This program and the accompanying materials
# are made available under the terms of the Eclipse Public License 2.0
# which accompanies this distribution, and is available at
# https://www.eclipse.org/legal/epl-2.0/
#
# SPDX-License-Identifier: EPL-2.0
#
# Contributors:
#    Neil Mackenzie - initial API and implementation
-->
{% extends 'base.html' %}

{% block content %}
<div style="height: 100vh; display: flex; flex-direction: column; gap: 20px;">
    <h1 style="margin: 0;">Review Semantic Integrations</h1>

    <!-- Add filter form -->
    <div class="filters" style="flex-shrink: 0;">
        <form method="get" class="filter-form">
            <div class="filter-group">
                <label for="mappingSelect">Select Mapping ID:</label>
                <select name="mapping_id" id="mappingSelect">
                    <option value="">All</option>
                    {% for mapping_data_item in mapping_data %}
                        <option value="{{ mapping_data_item }}" {% if selected_mapping == mapping_data_item %}selected{% endif %}>{{ mapping_data_item }}</option>
                    {% endfor %}
                </select>
            </div>

            <button type="submit" class="filter-button">Apply Filters</button>
        </form>
    </div>

    <div id="addRowModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 30px; font-size: 28px;">Add New Row</h2>
            <form id="addRowForm" style="max-height: 70vh; overflow-y: auto; display: flex; flex-direction: column;" onsubmit="submitForm(event)">
                <div style="display: flex; gap: 40px; flex: 1;">
                    <div class="source-column" style="flex: 1; padding: 20px;">
                        <h3 style="margin-bottom: 25px; color: #444;">Sources</h3>
                        {% for header, values in uniques_sources.items %}
                        <div class="form-group" style="margin-bottom: 25px;">
                            <label for="{{ header }}Select" style="margin-bottom: 10px;">Select {{ header }}:</label>
                            <select name="{{ header }}" id="{{ header }}Select" style="padding: 12px;">
                                {% for row in values %}
                                    <option value="{{ row }}">{{ row }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="target-column" style="flex: 1; padding: 20px;">
                        <h3 style="margin-bottom: 25px; color: #444;">Targets</h3>
                        {% for header, values in uniques_targets.items %}
                        <div class="form-group" style="margin-bottom: 25px;">
                            <label for="{{ header }}Select" style="margin-bottom: 10px;">Select {{ header }}:</label>
                            <select name="{{ header }}" id="{{ header }}Select" style="padding: 12px;">
                                {% for row in values %}
                                    <option value="{{ row }}">{{ row }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="form-buttons" style="width: 100%; padding: 20px; border-top: 1px solid #ddd; margin-top: auto;">
                    <button type="button" onclick="closeModal()" class="cancel-button" style="padding: 12px 24px; margin-right: 15px;">Cancel</button>
                    <button type="submit" class="submit-button" style="padding: 12px 24px;">Add Row</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Display member mapping rows as a table if selected -->
    <div style="flex: 1; min-height: 0; display: flex; flex-direction: column;">
        <div class="table-controls" style="flex-shrink: 0;">
            <button onclick="addRow()" class="table-control-btn" style="padding: 8px 16px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">Add Row</button>
        </div>
        <div style="flex: 1; overflow: auto;">
            <table class="member-mapping-table">
                <thead>
                    <tr>
                        {% for header in table_data.headers %}
                            <th style="{% if header in uniques_sources.keys %}background-color: #e6f3ff{% elif header in uniques_targets.keys %}background-color: #fff0e6{% endif %}">
                                {{ header }}
                            </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row in table_data.rows %}
                    <tr data-row>
                        {% for col_header, value in row.items %}
                        <td style="white-space: pre-wrap; word-wrap: break-word; word-break: break-all;">{{ value }}</td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
<script>
function addRow() {
    const modal = document.getElementById('addRowModal');
    modal.style.display = 'block';
}

function closeModal() {
    const modal = document.getElementById('addRowModal');
    modal.style.display = 'none';
}

function submitForm(event) {
    event.preventDefault();

    const form = document.getElementById('addRowForm');
    const formData = new FormData(form);
    const sourceData = {};
    const targetData = {};

    // Separate source and target values
    for(let [key, value] of formData.entries()) {
        if(document.querySelector('.source-column select[name="' + key + '"]')) {
            sourceData[key] = value;
        } else {
            targetData[key] = value;
        }
    }

    const data = {
        mapping_id: document.getElementById('mappingSelect').value,
        member_mapping_row: sourceData,
        member_mappings: [targetData]
    };

    fetch('/pybirdai/edit_mapping_endpoint', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        closeModal();
        // Optionally refresh the page or update the table
        location.reload();
    })
    .catch((error) => {
        console.error('Error:', error);
    });
}
</script>
<style>
    .pagination {
        margin-top: 20px;
    }
    table {
        border-collapse: collapse;
    }
    th, td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
    }
    th {
        background-color: #f2f2f2;
    }

    /* Add new filter styles */
    .filters {
        margin: 20px 0;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 5px;
    }

    .filters form {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: flex-end;
    }

    .filter-group {
        flex: 1;
        min-width: 200px;
    }

    .filters label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }

    .filters select {
        padding: 6px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        width: 100%;
    }
    .filter-button, .clear-button {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
    }

    .filter-button {
        background-color: #007bff;
        color: white;
    }

    .clear-button {
        background-color: #6c757d;
        color: white;
    }

    .filter-button:hover {
        background-color: #0056b3;
    }

    .clear-button:hover {
        background-color: #5a6268;
    }

    .create-button {
        margin-bottom: 20px;
        padding: 8px 16px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .create-button:hover {
        background-color: #45a049;
    }

    .modal {
        display: none;
        position: absolute;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 120%;
        background-color: rgba(0,0,0,0.4);
    }

    .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 40px;
        border: 1px solid #888;
        width: 80%;
        max-width: 800px;
        border-radius: 8px;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }

    .form-group input,
    .form-group select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    .form-buttons {
        margin-top: 20px;
        text-align: right;
    }

    .form-buttons button {
        margin-left: 10px;
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .submit-button {
        background-color: #4CAF50;
        color: white;
    }

    .cancel-button {
        background-color: #f44336;
        color: white;
    }
</style>
{% endblock %}
